# 验收标准 - 汇仁药业低代码平台

## 文档信息

| 项目 | 内容 |
|------|------|
| 版本 | v2.0 |
| 创建时间 | 2025-12-11 |
| 更新时间 | 2025-12-11 |

---

## 1. 场景1：OKR + 绩效管理全流程

### 1.1 HR创建绩效周期

#### Given（前置条件）
- 用户以 `hr` 账号登录
- 进入 `/performance/period` 页面

#### When（操作）
1. 点击"创建周期"按钮
2. 填写周期信息：
   - 名称：`2025Q4`
   - 类型：`季度考核`
   - 开始日期：`2025-10-01`
   - 结束日期：`2025-12-31`
3. 点击"保存"

#### Then（验收）
- ✅ 新周期出现在列表首行
- ✅ 状态为"未开始"
- ✅ 操作列显示"编辑"和"删除"按钮
- ✅ Debug窗口打印日志：`[时间戳] HR[XXX]创建绩效周期：2025Q4，类型：季度考核`

#### 失败路径
- **场景**：结束日期早于开始日期
- **期望**：表单提示"结束日期必须晚于开始日期"，无法提交

---

### 1.2 员工创建OKR

#### Given（前置条件）
- 用户以 `employee` 账号登录
- 进入 `/okr` 页面
- 已有绩效周期（2025Q4）

#### When（操作）
1. 点击"创建OKR"按钮
2. 填写Objective：`提升生产线合格率`
3. 添加3个Key Results：
   - KR1：`生产线A合格率从85%提升到95%`，权重30%
   - KR2：`不合格品数量从10批次降低到5批次`，权重40%
   - KR3：`员工质量培训覆盖率达到100%`，权重30%
4. 选择绩效周期：`2025Q4`
5. 点击"提交审批"

#### Then（验收）
- ✅ OKR创建成功，跳转到详情页
- ✅ 状态为"待审批"
- ✅ 整体进度为0%
- ✅ Debug窗口打印日志：
  ```
  [时间戳] 员工[XXX]创建OKR：提升生产线合格率
  [时间戳] 工作流引擎启动：OKR审批流程
  [时间戳] 发送通知：部门经理[XXX]
  ```

#### 失败路径
- **场景**：3个KR权重总和不等于100%（如：30% + 30% + 30% = 90%）
- **期望**：表单提示"权重总和必须为100%"，无法提交

---

### 1.3 部门经理审批OKR

#### Given（前置条件）
- 用户以 `manager` 账号登录
- 进入 `/okr/:id` 页面
- OKR状态为"待审批"

#### When（操作）
1. 查看OKR内容
2. 点击"审批"按钮
3. 选择"通过"
4. 填写审批意见：`目标合理，KR可量化，同意执行`
5. 点击"确认"

#### Then（验收）
- ✅ OKR状态变更为"执行中"
- ✅ 审批意见显示在详情页
- ✅ 审批时间显示在详情页
- ✅ 员工收到通知（弹窗或消息中心）
- ✅ Debug窗口打印日志：
  ```
  [时间戳] 部门经理[XXX]审批OKR：通过
  [时间戳] 工作流引擎：流转到下一节点（执行阶段）
  ```

#### 失败路径
- **场景**：选择"驳回"
- **期望**：
  - OKR状态变更为"已驳回"
  - 员工可重新编辑OKR
  - Debug窗口打印：`部门经理[XXX]驳回OKR，原因：XXX`

---

### 1.4 员工更新KR进度

#### Given（前置条件）
- 用户以 `employee` 账号登录
- 进入 `/okr/:id` 页面
- OKR状态为"执行中"

#### When（操作）
1. 点击KR1的"更新进度"按钮
2. 输入当前值：`90`（目标95，初始85）
3. 点击"保存"

#### Then（验收）
- ✅ KR1进度条更新为50%（计算公式：(90-85)/(95-85) × 100% = 50%）
- ✅ OKR整体完成度更新为15%（KR1权重30% × 进度50% = 15%）
- ✅ Debug窗口打印日志：
  ```
  [时间戳] 员工[XXX]更新KR进度：生产线A合格率 90%（目标95%）
  [时间戳] 计算OKR完成度：0% → 15%
  ```

#### 边界测试
- **场景**：输入当前值 > 目标值（如输入100）
- **期望**：KR进度为100%，整体完成度上限为100%

---

### 1.5 季度末绩效评估

#### Given（前置条件）
- 用户以 `hr` 账号登录
- 进入 `/performance` 页面
- 绩效周期状态为"评估中"

#### When（操作）
1. 点击"开始评估"按钮
2. 系统自动拉取所有员工的OKR完成度
3. 部门经理为员工打分（1-5分）
4. 系统计算最终绩效 = OKR完成度（60%）+ 主观评分（40%）
5. HR点击"导出绩效报表"

#### Then（验收）
- ✅ 绩效周期状态变更为"已结束"
- ✅ 员工可在 `/performance` 查看自己的绩效得分
- ✅ 导出Excel文件，包含字段：员工姓名、部门、OKR完成度、主观评分、最终绩效
- ✅ Debug窗口打印日志：
  ```
  [时间戳] 绩效周期[2025Q4]结束
  [时间戳] 计算绩效得分：张三=4.2分（OKR 80% + 主观4分）
  [时间戳] 导出绩效报表：performance_2025Q4.xlsx
  ```

#### 失败路径
- **场景**：周期内存在未完成审批的OKR
- **期望**：提示"存在未完成审批的OKR，无法结束周期"

---

## 2. 场景2：生产 + 质量管理联动

### 2.1 车间班组长提报异常工单

#### Given（前置条件）
- 用户以 `employee` 账号登录（车间班组长）
- 进入 `/production/workorder` 页面

#### When（操作）
1. 点击"创建工单"按钮
2. 填写字段：
   - 异常类型：`工艺偏差`
   - 批次号：`202512001`
   - 异常描述：`发现生产线温度超标，可能影响产品质量`
   - 现场照片：上传2张图片
3. 点击"提交"

#### Then（验收）
- ✅ 工单创建成功，状态为"待处理"
- ✅ 工单编号自动生成（格式：`WO-20251211-0001`）
- ✅ 触发工作流引擎，自动分配到质检部门
- ✅ 如果异常类型为"工艺偏差"，同时查询QMS批次数据（占位）
- ✅ Debug窗口打印日志：
  ```
  [时间戳] 车间班组长[XXX]创建工单：批次202512001工艺偏差
  [时间戳] 工作流引擎启动：生产异常处理流程
  [时间戳] API调用：QMS批次查询接口 → /api/qms/batch/202512001
  [时间戳] QMS返回：批次202512001，检验状态=待检
  ```

#### 失败路径
- **场景**：批次号格式错误（非数字）
- **期望**：表单提示"批次号格式错误，请输入9位数字"

---

### 2.2 质检员处理工单

#### Given（前置条件）
- 用户以 `employee` 账号登录（质检员）
- 进入 `/production/workorder/:id` 页面
- 工单状态为"待处理"或"处理中"

#### When（操作）
1. 查看工单内容
2. 点击"查询QMS数据"按钮
3. 系统展示批次检验数据（模拟）：
   - 批次号：202512001
   - 合格率：87%（低于阈值90%）
   - 不合格项：重金属超标
4. 填写处理意见：`建议立即停产，等待复检`
5. 点击"提交"

#### Then（验收）
- ✅ 工单状态变更为"已处理"
- ✅ 如果合格率 < 90%，触发预警，通知部门经理
- ✅ Debug窗口打印日志：
  ```
  [时间戳] 质检员[XXX]处理工单：批次202512001
  [时间戳] QMS数据查询完成：合格率=87%（低于阈值90%）
  [时间戳] 触发预警：通知部门经理[XXX]
  [时间戳] 工作流引擎：流转到审批节点
  ```

#### 失败路径
- **场景**：QMS接口超时（5秒无响应）
- **期望**：
  - 显示"QMS数据查询失败，请稍后重试"
  - Debug窗口打印：`[时间戳] 错误：QMS连接超时（5秒无响应）`

---

### 2.3 部门经理查看异常统计看板

#### Given（前置条件）
- 用户以 `manager` 账号登录
- 进入 `/overview` 页面

#### When（操作）
1. 页面自动加载
2. 展示"今日异常工单"卡片（数量 + 趋势图）
3. 点击卡片跳转到 `/production/workorder`
4. 筛选"本周质量异常"
5. 查看趋势图（按日期聚合）

#### Then（验收）
- ✅ 卡片显示今日异常工单数量（如：8件）
- ✅ 趋势图显示最近7天的异常工单数量变化
- ✅ 筛选功能正常（按状态、类型、时间）
- ✅ Debug窗口打印日志：
  ```
  [时间戳] 部门经理[XXX]查看运营总览
  [时间戳] 数据聚合：本周质量异常工单=12件（上周8件，环比+50%）
  ```

#### 边界测试
- **场景**：无异常工单
- **期望**：显示空状态插图 + "暂无异常工单"

---

## 3. 场景3：多系统数据聚合展示

### 3.1 系统管理员配置数据源

#### Given（前置条件）
- 用户以 `admin` 账号登录
- 进入 `/datasource` 页面

#### When（操作）
1. 点击"新增数据源"按钮
2. 选择数据源类型：`REST API`
3. 填写连接参数：
   - 名称：`MES生产执行系统`
   - Endpoint：`http://mes.huiren.local/api/v1`
   - 认证方式：`API Token`
   - Token：`xxxxx-xxxxx-xxxxx`
4. 点击"测试连接"

#### Then（验收）
- ✅ 显示绿色勾选 + "连接成功"
- ✅ 保存数据源配置
- ✅ 数据源列表显示新增项
- ✅ Debug窗口打印日志：
  ```
  [时间戳] 系统管理员[admin]创建数据源：MES生产执行系统
  [时间戳] 连接测试：REST API → http://mes.huiren.local/api/v1
  [时间戳] 测试结果：成功（模拟数据）
  ```

#### 失败路径
- **场景**：Endpoint格式错误（非URL）
- **期望**：表单提示"请输入有效的URL"

---

### 3.2 查看数据血缘图

#### Given（前置条件）
- 用户以 `admin` 账号登录
- 进入 `/datasource/lineage` 页面
- 已配置至少1个数据源

#### When（操作）
1. 页面自动加载
2. 展示可视化数据流向图（ECharts关系图）
3. 点击节点查看详细信息

#### Then（验收）
- ✅ 渲染节点：
  - 源系统（蓝色圆形）：MES、QMS、WMS、ERP、OA、CRM
  - 数据表（橙色矩形）：production_data、quality_data、inventory_data
  - 目标应用（绿色圆形）：运营总览、质量日报、库存预警
- ✅ 节点可拖拽
- ✅ 点击节点显示详情弹窗（表结构、刷新频率）
- ✅ Debug窗口打印日志：
  ```
  [时间戳] 系统管理员[admin]查看数据血缘图
  [时间戳] 渲染节点：6个源系统 + 12个数据表 + 8个目标应用
  ```

#### 边界测试
- **场景**：无数据源配置
- **期望**：显示空状态插图 + "请先配置数据源"

---

### 3.3 运营总览大屏展示

#### Given（前置条件）
- 用户以 `leader` 账号登录（高层领导）
- 进入 `/overview` 页面
- 已配置6个数据源

#### When（操作）
1. 页面自动加载
2. 调用所有数据源API（模拟）
3. 展示关键指标卡片：
   - 今日产量：1200件（目标1500件，完成率80%）
   - 合格率：92%（趋势图显示上升）
   - 库存预警：3个品种低于安全库存
   - 待处理工单：8件
4. 展示系统连接状态模块：
   - MES：在线（绿色）
   - QMS：在线（绿色）
   - WMS：在线（绿色）
   - ERP：离线（红色，显示"连接超时"）
   - OA：在线（绿色）
   - CRM：在线（绿色）
5. 自动刷新（30秒）

#### Then（验收）
- ✅ 所有卡片正常展示（即使某个系统离线）
- ✅ 系统连接状态实时更新
- ✅ 点击卡片跳转到对应页面
- ✅ Debug窗口打印日志：
  ```
  [时间戳] 高层领导[总经理]进入运营总览
  [时间戳] API调用：MES → /api/production/today → 返回1200件
  [时间戳] API调用：QMS → /api/quality/rate → 返回92%
  [时间戳] API调用：WMS → /api/inventory/alert → 返回3件预警
  [时间戳] API调用：ERP → /api/order/status → 超时（5秒无响应）
  [时间戳] 警告：ERP连接异常，请检查网络
  ```

#### 失败路径
- **场景**：所有系统离线
- **期望**：显示警告提示 + "无法加载数据，请检查系统连接"

---

### 3.4 配置KPI指标字典

#### Given（前置条件）
- 用户以 `admin` 账号登录
- 进入 `/kpi/dict` 页面

#### When（操作）
1. 点击"新增指标"按钮
2. 填写指标信息：
   - 指标名称：`今日产量`
   - 指标编码：`daily_output`
   - 来源系统：`MES`
   - 数据表：`production_summary`
   - 计算公式：`SUM(completed_quantity)`
   - 刷新频率：`每2小时`
   - 责任部门：`生产部`
   - 责任人：`李四`
3. 点击"保存"

#### Then（验收）
- ✅ 指标出现在字典列表
- ✅ 其他页面可引用该指标（如运营总览）
- ✅ Debug窗口打印日志：
  ```
  [时间戳] 系统管理员[admin]创建KPI指标：今日产量
  [时间戳] 指标定义：来源MES，计算公式SUM(completed_quantity)
  ```

#### 失败路径
- **场景**：指标编码重复
- **期望**：表单提示"指标编码已存在，请使用其他编码"

---

## 4. API校验

### 4.1 参数校验

| API | 参数 | 校验规则 | 错误码 | 错误信息 |
|-----|------|---------|--------|---------|
| `POST /api/v1/okrs` | `objective` | 必填，长度5-500字符 | H4001 | "目标描述不能为空" |
| `POST /api/v1/okrs` | `key_results` | 必填，数组长度1-5 | H4002 | "至少需要1个关键结果" |
| `POST /api/v1/okrs/:id/approve` | `action` | 枚举值：approve/reject | H4003 | "审批动作无效" |
| `POST /api/v1/datasources` | `endpoint` | URL格式 | H4004 | "请输入有效的URL" |

---

### 4.2 错误码

| 错误码 | 说明 | HTTP状态码 |
|--------|------|-----------|
| H2000 | 成功 | 200 |
| H4001 | 参数错误 | 400 |
| H4011 | 未认证 | 401 |
| H4031 | 无权限 | 403 |
| H4041 | 资源不存在 | 404 |
| H5001 | 服务器内部错误 | 500 |
| H5031 | 外部服务不可用（如QMS） | 503 |

---

### 4.3 数据一致性

| 场景 | 验收标准 |
|------|---------|
| OKR完成度计算 | `overall_progress = SUM(key_result.progress × key_result.weight)` |
| 绩效得分计算 | `final_score = okr_completion × 0.6 + manager_score × 0.4` |
| 库存预警判断 | `alert_level = 'critical' IF quantity < safety_stock × 0.5` |
| 工单编号生成 | 格式：`WO-YYYYMMDD-XXXX`（X为4位递增序号） |

---

### 4.4 口径一致性

| 指标 | 计算公式 | 验收 |
|------|---------|------|
| 今日产量 | `SUM(completed_quantity) WHERE production_date = CURRENT_DATE AND status = 'completed'` | ✅ 与KPI字典一致 |
| 合格率 | `(COUNT(result = '合格') / COUNT(*)) × 100%` | ✅ 与QMS返回数据一致 |
| 库存预警数量 | `COUNT(*) WHERE quantity < safety_stock` | ✅ 与WMS返回数据一致 |

---

## 5. 权限与边界

### 5.1 权限控制

| 页面 | 员工 | 经理 | HR | 管理员 | 领导 |
|------|------|------|----|---------|----|
| `/overview` | ✅ | ✅ | ✅ | ✅ | ✅ |
| `/okr` | ✅ | ✅ | ✅ | ✅ | ✅ |
| `/performance` | ✅（仅本人） | ✅ | ✅ | ✅ | ✅ |
| `/performance/period` | ❌ | ❌ | ✅ | ✅ | ✅ |
| `/datasource` | ❌ | ❌ | ❌ | ✅ | ❌ |
| `/production/workorder` | ✅ | ✅ | ✅ | ✅ | ✅ |

---

### 5.2 边界测试

| 场景 | 输入 | 期望输出 |
|------|------|---------|
| KR进度更新 | 当前值 = 目标值 | 进度100% |
| KR进度更新 | 当前值 > 目标值 | 进度100%（上限） |
| KR进度更新 | 当前值 < 初始值 | 进度0%（下限） |
| 权重总和 | 30% + 40% + 40% = 110% | 提示"权重总和必须为100%" |
| 文件上传 | 文件大小 > 5MB | 提示"文件大小不能超过5MB" |
| 批次号输入 | 非数字字符 | 提示"批次号格式错误" |

---

**文档结束**
