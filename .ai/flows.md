# 流程与交互设计 - 汇仁药业低代码平台

## 文档信息

| 项目 | 内容 |
|------|------|
| 版本 | v2.0 |
| 创建时间 | 2025-12-11 |
| 更新时间 | 2025-12-11 |

---

## 1. 页面关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                          登录页 (Login)                           │
│                     /login - Login.vue                           │
└─────────────────────┬───────────────────────────────────────────┘
                      │ 登录成功
                      ↓
┌─────────────────────────────────────────────────────────────────┐
│                      主框架 (Dashboard)                           │
│                    / - Dashboard.vue                             │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  侧边栏导航                                                │  │
│  │  ├─ 运营总览                                              │  │
│  │  ├─ OKR管理                                               │  │
│  │  ├─ 绩效管理 (子菜单)                                     │  │
│  │  ├─ 生产管理 (子菜单)                                     │  │
│  │  ├─ 质量管理 (子菜单)                                     │  │
│  │  ├─ 供应链管理 (子菜单)                                   │  │
│  │  ├─ 数据集成 (子菜单)                                     │  │
│  │  └─ 低代码工具 (子菜单)                                   │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────┬───────────────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┬─────────────────────┐
        ↓             ↓             ↓                     ↓
  ┌──────────┐  ┌──────────┐  ┌──────────┐        ┌──────────┐
  │运营总览  │  │OKR管理   │  │绩效管理  │  ...  │低代码工具│
  │/overview │  │/okr      │  │/performance│      │/lowcode/*│
  └──────────┘  └──────────┘  └──────────┘        └──────────┘
```

### 1.1 调整后的完整导航结构

```
低代码平台
├─ 登录 (/login) - Login.vue
└─ 主框架 (/) - Dashboard.vue
    ├─ 运营总览 (/overview) - OperationalDashboard.vue
    │
    ├─ OKR与绩效
    │   ├─ OKR管理 (/okr) - OKRList.vue
    │   │   ├─ 创建OKR (/okr/create) - OKRCreate.vue
    │   │   └─ OKR详情 (/okr/:id) - OKRDetail.vue
    │   ├─ 绩效管理 (/performance) - PerformanceManagement.vue
    │   └─ 绩效周期管理 (/performance/period) - PerformancePeriodManagement.vue
    │
    ├─ 生产管理
    │   ├─ 生产异常工单 (/production/workorder) - ProductionWorkOrder.vue
    │   ├─ 生产进度看板 (/production/progress) - 【新增】
    │   └─ 设备状态监控 (/production/equipment) - 【新增占位】
    │
    ├─ 质量管理
    │   ├─ 质量检验工单 (/quality/inspection) - 【新增】
    │   ├─ 不合格品统计 (/quality/defect) - 【新增占位】
    │   └─ 批次追溯 (/quality/traceability) - 【新增占位】
    │
    ├─ 供应链管理
    │   ├─ 库存预警 (/supply/inventory) - 【新增】
    │   ├─ 订单履约看板 (/supply/order) - 【新增】
    │   └─ 经销商画像 (/supply/dealer) - 【新增】
    │
    ├─ 数据集成
    │   ├─ 数据源配置 (/datasource) - DataSourceList.vue
    │   │   └─ 配置详情 (/datasource/config/:id?) - DataSourceConfig.vue
    │   ├─ 数据血缘 (/datasource/lineage) - DataLineage.vue
    │   ├─ 数据同步任务 (/datasync) - SyncTaskList.vue
    │   └─ KPI指标字典 (/kpi/dict) - KPIMetricDict.vue
    │
    ├─ 低代码工具
    │   ├─ 表单设计器 (/lowcode/form-designer) - FormDesigner.vue
    │   ├─ 工作流设计器 (/lowcode/workflow-designer) - WorkflowDesigner.vue
    │   ├─ 页面构建器 (/lowcode/page-builder) - PageBuilder.vue
    │   ├─ API管理 (/lowcode/api-management) - APIManagement.vue
    │   └─ 应用市场 (/lowcode/app-market) - AppMarket.vue
    │
    └─ 其他场景
        └─ 费用报销 (/scenarios/expense) - ExpenseReimbursement.vue
```

---

## 2. 关键交互流程

### 2.1 场景1：OKR + 绩效管理全流程

#### 步骤1：HR创建绩效周期
**页面**：`/performance/period`

**事件**：点击"创建周期"按钮
**行为**：
1. 弹出模态框
2. 填写周期信息（名称、类型、开始时间、结束时间、评分规则）
3. 点击"保存"

**结果**：
- 新周期出现在列表
- 状态为"未开始"
- Debug窗口打印日志：`[2025-12-11 18:45:12] 创建绩效周期：2025Q4，类型：季度考核`

---

#### 步骤2：员工创建OKR
**页面**：`/okr` → `/okr/create`

**事件**：点击"创建OKR"按钮
**行为**：
1. 跳转到创建页面
2. 填写Objective（目标描述）
3. 动态添加多个Key Results（关键结果）
   - KR名称
   - 初始值 / 目标值
   - 权重（自动平衡到100%）
4. 选择绩效周期（下拉框）
5. 点击"提交审批"

**结果**：
- OKR创建成功
- 状态为"待审批"
- 触发工作流引擎：通知部门经理审批
- Debug窗口打印日志：
  ```
  [2025-12-11 18:46:30] 员工[张三]创建OKR：提升生产线合格率
  [2025-12-11 18:46:30] 工作流引擎启动：OKR审批流程
  [2025-12-11 18:46:30] 发送通知：部门经理[李四]
  ```

---

#### 步骤3：部门经理审批OKR
**页面**：`/okr/:id`

**事件**：部门经理登录后，进入OKR详情
**行为**：
1. 查看OKR内容
2. 点击"审批"按钮
3. 选择"通过"或"驳回"
4. 填写审批意见
5. 点击"确认"

**结果**：
- OKR状态变更为"执行中"（通过）或"已驳回"
- 员工收到通知
- Debug窗口打印日志：
  ```
  [2025-12-11 18:47:15] 部门经理[李四]审批OKR：通过
  [2025-12-11 18:47:15] 工作流引擎：流转到下一节点（执行阶段）
  ```

---

#### 步骤4：员工更新KR进度
**页面**：`/okr/:id`

**事件**：点击KR行的"更新进度"按钮
**行为**：
1. 弹出输入框
2. 输入当前值（如"合格率从85%提升到90%"）
3. 系统自动计算进度百分比
4. 点击"保存"

**结果**：
- KR进度条更新
- 整体OKR完成度自动重新计算
- Debug窗口打印日志：
  ```
  [2025-12-11 18:50:00] 员工[张三]更新KR进度：生产线合格率 90%（目标95%）
  [2025-12-11 18:50:00] 计算OKR完成度：75% → 80%
  ```

---

#### 步骤5：季度末绩效评估
**页面**：`/performance`

**事件**：HR点击"开始评估"按钮
**行为**：
1. 系统自动拉取所有员工的OKR完成度
2. 部门经理为每个员工打分（1-5分）
3. 最终绩效 = OKR完成度（60%）+ 主观评分（40%）
4. HR导出绩效数据（Excel）

**结果**：
- 绩效周期状态变更为"已结束"
- 员工可查看自己的绩效得分
- Debug窗口打印日志：
  ```
  [2025-12-11 19:00:00] 绩效周期[2025Q4]结束
  [2025-12-11 19:00:00] 计算绩效得分：张三=4.2分（OKR 80% + 主观4分）
  [2025-12-11 19:00:00] 导出绩效报表：performance_2025Q4.xlsx
  ```

---

### 2.2 场景2：生产 + 质量管理联动

#### 步骤1：车间班组长提报异常工单
**页面**：`/production/workorder`

**事件**：点击"创建工单"按钮
**行为**：
1. 弹出表单（由表单设计器生成）
2. 填写字段：
   - 异常类型（下拉：设备故障/物料问题/工艺偏差）
   - 批次号（输入框）
   - 异常描述（富文本）
   - 现场照片（图片上传）
3. 点击"提交"

**结果**：
- 工单创建成功，状态为"待处理"
- 触发工作流引擎：自动分配到质检部门
- 如果异常类型为"工艺偏差"，同时查询QMS批次数据（占位）
- Debug窗口打印日志：
  ```
  [2025-12-11 18:48:00] 车间班组长[王五]创建工单：批次202512001工艺偏差
  [2025-12-11 18:48:00] 工作流引擎启动：生产异常处理流程
  [2025-12-11 18:48:00] API调用：QMS批次查询接口 → /api/qms/batch/202512001
  [2025-12-11 18:48:00] QMS返回：批次202512001，检验状态=待检
  ```

---

#### 步骤2：质检员处理工单
**页面**：`/quality/inspection`（新增页面）

**事件**：质检员从工单列表进入详情
**行为**：
1. 查看工单内容
2. 从QMS调取批次检验数据（占位：显示模拟数据）
3. 判断是否需要停产（如果合格率 < 90%）
4. 填写处理意见
5. 点击"提交"

**结果**：
- 工单状态变更为"已处理"
- 如果需要停产，触发通知到部门经理
- Debug窗口打印日志：
  ```
  [2025-12-11 18:50:00] 质检员[赵六]处理工单：批次202512001
  [2025-12-11 18:50:00] QMS数据查询完成：合格率=87%（低于阈值90%）
  [2025-12-11 18:50:00] 触发预警：通知部门经理[李四]
  [2025-12-11 18:50:00] 工作流引擎：流转到审批节点
  ```

---

#### 步骤3：部门经理查看异常统计看板
**页面**：`/overview`（运营总览）

**事件**：页面自动加载
**行为**：
1. 展示"今日异常工单"卡片（数量+趋势图）
2. 点击卡片跳转到工单列表
3. 筛选"本周质量异常"
4. 查看趋势图（按日期聚合）

**结果**：
- 发现质量异常上升趋势
- 决策是否启动质量改进项目
- Debug窗口打印日志：
  ```
  [2025-12-11 18:52:00] 部门经理[李四]查看运营总览
  [2025-12-11 18:52:00] 数据聚合：本周质量异常工单=12件（上周8件，环比+50%）
  ```

---

### 2.3 场景3：多系统数据聚合展示

#### 步骤1：系统管理员配置数据源
**页面**：`/datasource`

**事件**：点击"新增数据源"按钮
**行为**：
1. 选择数据源类型（PostgreSQL / MySQL / REST API / OData）
2. 填写连接参数：
   - 名称：MES生产执行系统
   - 类型：REST API
   - Endpoint：http://mes.huiren.local/api/v1
   - 认证方式：API Token
   - Token：xxxxx-xxxxx-xxxxx
3. 点击"测试连接"

**结果**：
- 模拟连接成功（显示绿色勾选）
- 保存数据源配置
- Debug窗口打印日志：
  ```
  [2025-12-11 19:00:00] 系统管理员[admin]创建数据源：MES生产执行系统
  [2025-12-11 19:00:00] 连接测试：REST API → http://mes.huiren.local/api/v1
  [2025-12-11 19:00:00] 测试结果：成功（模拟数据）
  ```

**重复操作**：依次配置 QMS、WMS、ERP、OA、CRM

---

#### 步骤2：查看数据血缘图
**页面**：`/datasource/lineage`

**事件**：页面自动加载
**行为**：
1. 展示可视化数据流向图（使用ECharts关系图）
2. 节点类型：
   - 源系统（蓝色圆形）：MES、QMS、WMS、ERP、OA、CRM
   - 数据表（橙色矩形）：production_data、quality_data、inventory_data
   - 目标应用（绿色圆形）：运营总览、质量日报、库存预警
3. 点击节点查看详细信息

**结果**：
- 清晰展示数据来源与去向
- 辅助排查数据质量问题
- Debug窗口打印日志：
  ```
  [2025-12-11 19:02:00] 系统管理员[admin]查看数据血缘图
  [2025-12-11 19:02:00] 渲染节点：6个源系统 + 12个数据表 + 8个目标应用
  ```

---

#### 步骤3：运营总览大屏展示
**页面**：`/overview`

**事件**：高层领导登录后进入
**行为**：
1. 页面自动加载，调用所有数据源API（模拟）
2. 展示关键指标卡片：
   - **今日产量**：来源MES，1200件（目标1500件，完成率80%）
   - **合格率**：来源QMS，92%（趋势图显示上升）
   - **库存预警**：来源WMS，3个品种低于安全库存
   - **待处理工单**：来源低代码平台，8件
3. 展示系统连接状态模块：
   - MES：在线（绿色）
   - QMS：在线（绿色）
   - WMS：在线（绿色）
   - ERP：离线（红色，显示"连接超时"）
   - OA：在线（绿色）
   - CRM：在线（绿色）
4. 自动刷新（每30秒）

**结果**：
- 高层领导一眼掌握全局
- 发现ERP系统连接异常，通知IT部门排查
- Debug窗口打印日志：
  ```
  [2025-12-11 19:05:00] 高层领导[总经理]进入运营总览
  [2025-12-11 19:05:00] API调用：MES → /api/production/today → 返回1200件
  [2025-12-11 19:05:00] API调用：QMS → /api/quality/rate → 返回92%
  [2025-12-11 19:05:00] API调用：WMS → /api/inventory/alert → 返回3件预警
  [2025-12-11 19:05:00] API调用：ERP → /api/order/status → 超时（5秒无响应）
  [2025-12-11 19:05:00] 警告：ERP连接异常，请检查网络
  ```

---

#### 步骤4：配置KPI指标字典
**页面**：`/kpi/dict`

**事件**：点击"新增指标"按钮
**行为**：
1. 填写指标信息：
   - 指标名称：今日产量
   - 指标编码：daily_output
   - 来源系统：MES
   - 数据表：production_summary
   - 计算公式：SUM(completed_quantity)
   - 刷新频率：每2小时
   - 责任部门：生产部
   - 责任人：李四
2. 点击"保存"

**结果**：
- 指标出现在字典列表
- 其他页面可引用该指标
- Debug窗口打印日志：
  ```
  [2025-12-11 19:10:00] 系统管理员[admin]创建KPI指标：今日产量
  [2025-12-11 19:10:00] 指标定义：来源MES，计算公式SUM(completed_quantity)
  ```

---

## 3. 空态与异常处理

### 3.1 空态

| 页面 | 空态场景 | 展示内容 |
|------|---------|---------|
| OKR列表 | 无OKR数据 | 空状态插图 + "暂无OKR，点击创建" |
| 绩效管理 | 无绩效周期 | 空状态插图 + "请先创建绩效周期" |
| 数据源配置 | 无数据源 | 空状态插图 + "点击新增数据源" |
| 生产异常工单 | 无工单 | 空状态插图 + "暂无异常工单" |
| 运营总览 | 所有系统离线 | 警告提示 + "无法加载数据，请检查系统连接" |

### 3.2 权限不足

| 页面 | 权限要求 | 异常处理 |
|------|---------|---------|
| 数据源配置 | 仅管理员 | 普通员工访问：显示403页面 + "无权限访问，请联系管理员" |
| 绩效周期管理 | 管理员/HR | 普通员工访问：重定向到 `/overview` |
| KPI指标字典 | 管理员/经理 | 普通员工访问：仅可查看，不可编辑 |

### 3.3 接口失败

| 场景 | 失败原因 | 处理方式 |
|------|---------|---------|
| 创建OKR | 服务器错误 | 弹出错误提示 + "创建失败，请稍后重试" + Debug窗口打印错误栈 |
| 数据源连接测试 | 连接超时 | 显示红色叉号 + "连接超时，请检查网络或配置" |
| 运营总览数据加载 | API返回500 | 卡片显示"数据加载失败" + 提供"重试"按钮 |
| 工单流转 | 工作流引擎异常 | 工单状态不变 + Debug窗口打印错误日志 + 通知管理员 |

### 3.4 超时

| 场景 | 超时阈值 | 处理方式 |
|------|---------|---------|
| 数据源连接测试 | 5秒 | 中断请求，显示"连接超时" |
| 运营总览API调用 | 3秒 | 显示"加载超时"，但不阻塞其他卡片加载 |
| 表单提交 | 10秒 | 显示加载动画，超时后提示"提交超时，请检查网络" |

---

## 4. 状态迁移

### 4.1 OKR状态机

```
草稿 (draft)
    ↓ 员工提交
待审批 (pending_approval)
    ↓ 经理审批通过          ↓ 经理驳回
执行中 (in_progress)    已驳回 (rejected)
    ↓ 季度结束
已完成 (completed)
```

### 4.2 工单状态机

```
待处理 (pending)
    ↓ 分配处理人
处理中 (in_progress)
    ↓ 质检员提交处理结果
待审批 (pending_approval) ←─┐
    ↓ 经理审批通过          │
已完成 (completed)          │
    ↓ 如果需要返工           │
    └─────────────────────┘
```

### 4.3 绩效周期状态机

```
未开始 (not_started)
    ↓ 到达开始日期
进行中 (in_progress)
    ↓ 到达结束日期
评估中 (evaluating)
    ↓ HR完成评估
已结束 (completed)
```

---

## 5. Debug窗口展示规则

### 5.1 展示内容

| 日志类型 | 颜色 | 示例 |
|---------|------|------|
| API调用 | 蓝色 | `[19:00:00] API调用：GET /api/okr/list → 200 OK` |
| 工作流流转 | 绿色 | `[19:01:00] 工作流引擎：OKR审批流程 → 流转到审批节点` |
| 数据同步 | 橙色 | `[19:02:00] 数据同步：MES → production_data（10条记录）` |
| 错误异常 | 红色 | `[19:03:00] 错误：ERP连接超时（5秒无响应）` |
| 用户操作 | 灰色 | `[19:04:00] 用户[张三]创建OKR：提升生产线合格率` |

### 5.2 展示位置

- **位置**：右下角浮动窗口
- **尺寸**：400px × 300px（可拖拽调整）
- **展开/收起**：点击标题栏切换
- **清空按钮**：点击"清空日志"

### 5.3 日志保留策略

- **最大行数**：200行
- **超出处理**：删除最早的日志
- **刷新策略**：页面刷新后清空（可配置"持久化到本地存储"）

---

## 6. 失败重试

| 场景 | 重试策略 | 最大重试次数 |
|------|---------|-------------|
| API调用失败 | 指数退避（1s → 2s → 4s） | 3次 |
| 数据源连接测试 | 无自动重试，用户手动点击 | - |
| 工作流流转失败 | 立即重试1次，失败后记录错误日志 | 1次 |
| 运营总览数据加载 | 点击"重试"按钮手动重试 | - |

---

**文档结束**
